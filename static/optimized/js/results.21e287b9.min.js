function e(e){const t=document.getElementById("resultCard");if(!t)return;t.style.display="block";const s=document.getElementById("batchResultCard");s&&(s.style.display="none");const a=document.getElementById("backToBatchBtn");a&&(a.style.display="none");const i=document.getElementById("resultTitle");i&&(i.textContent=e.filename||"Invoice Processing Results"),n(e.confidence_scores),o(e.extracted_data);const d=document.getElementById("jsonData");d&&(d.textContent=JSON.stringify(e,null,2)),u(e)}function t(t){const n=document.getElementById("batchResultCard");if(!n)return;n.style.display="block";const i=document.getElementById("resultCard");i&&(i.style.display="none");const o=document.getElementById("batchResultsTable");o&&(o.innerHTML="",t.results.forEach((n,i)=>{const d=document.createElement("tr");d.className="invoice-row",d.dataset.index=i;const c=s(n.confidence_scores),r=n.extracted_data?.invoice_number||"N/A",l=n.extracted_data?.vendor_name||"Unknown",u=n.extracted_data?.date||"N/A",m=n.extracted_data?.total_amount?`$${n.extracted_data.total_amount}`:"N/A";d.innerHTML=`\n                <td>${n.filename||`Invoice ${i+1}`}</td>\n                <td>${l}</td>\n                <td>${r}</td>\n                <td>${u}</td>\n                <td>${m}</td>\n                <td>\n                    <div class="progress">\n                        <div class="progress-bar ${a(c)}" \n                             role="progressbar" \n                             style="width: ${c}%" \n                             aria-valuenow="${c}" \n                             aria-valuemin="0" \n                             aria-valuemax="100">\n                            ${c}%\n                        </div>\n                    </div>\n                </td>\n                <td>\n                    <button class="btn btn-sm btn-primary view-invoice-btn">\n                        <i class="bi bi-eye"></i> View\n                    </button>\n                </td>\n            `,o.appendChild(d);const f=d.querySelector(".view-invoice-btn");f&&f.addEventListener("click",function(){e(t.results[i]);const n=document.getElementById("backToBatchBtn");n&&(n.style.display="block")})}));const d=document.getElementById("totalInvoices");d&&(d.textContent=t.results.length);const c=document.getElementById("avgConfidence");if(c){let e=0;t.results.forEach(t=>{e+=s(t.confidence_scores)});const n=Math.round(e/t.results.length);c.textContent=`${n}%`}const r=document.getElementById("totalAmount");if(r){let e=0;t.results.forEach(t=>{if(t.extracted_data?.total_amount){const n=parseFloat(t.extracted_data.total_amount);isNaN(n)||(e+=n)}}),r.textContent=`$${e.toFixed(2)}`}m(t.results)}function n(e){const t=document.getElementById("confidenceScore");if(!t)return;const n=s(e);t.textContent=`${n}%`,t.className=`confidence-score ${a(n)}`;const o=document.getElementById("confidenceGauge");o&&(o.style.setProperty("--percentage",`${n}%`),o.className=`confidence-gauge ${a(n)}`),i(e)}function s(e){if(!e||"object"!=typeof e)return 85;const t=Object.values(e).filter(e=>"number"==typeof e);if(0===t.length)return 85;const n=t.reduce((e,t)=>e+t,0)/t.length;return Math.round(100*n)}function a(e){return e>=90?"confidence-high":e>=75?"confidence-medium":e>=60?"confidence-low":"confidence-very-low"}function i(e){const t=document.getElementById("confidenceBreakdown");t&&e&&(t.innerHTML="",Object.entries(e).forEach(([e,n])=>{if("number"!=typeof n)return;const s=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),i=Math.round(100*n),o=document.createElement("div");o.className="confidence-breakdown-item mb-2",o.innerHTML=`\n            <div class="d-flex justify-content-between mb-1">\n                <span>${s}</span>\n                <span>${i}%</span>\n            </div>\n            <div class="progress">\n                <div class="progress-bar ${a(i)}" \n                     role="progressbar" \n                     style="width: ${i}%" \n                     aria-valuenow="${i}" \n                     aria-valuemin="0" \n                     aria-valuemax="100"></div>\n            </div>\n        `,t.appendChild(o)}))}function o(e){e&&(d("invoiceNumber",e.invoice_number),d("invoiceDate",e.date),d("dueDate",e.due_date),d("poNumber",e.po_number),d("vendorName",e.vendor_name),d("vendorAddress",e.vendor_address),d("billToName",e.bill_to_name),d("billToAddress",e.bill_to_address),d("subtotal",e.subtotal,!0),d("tax",e.tax,!0),d("totalAmount",e.total_amount,!0),c(e.line_items),r())}function d(e,t,n=!1){const s=document.getElementById(e);if(!s)return;let a=t;n&&t&&(a="number"==typeof t?`$${t.toFixed(2)}`:`$${t}`),s.textContent=a||"N/A",t?s.classList.remove("not-available"):s.classList.add("not-available")}function c(e){const t=document.getElementById("lineItemsTable");if(t){if(t.innerHTML="",!e||0===e.length){const e=document.createElement("tr");return e.innerHTML='\n            <td colspan="5" class="text-center">No line items found</td>\n        ',void t.appendChild(e)}e.forEach((e,n)=>{const s=document.createElement("tr");s.innerHTML=`\n            <td class="editable" data-field="description" data-index="${n}">${e.description||"N/A"}</td>\n            <td class="editable text-center" data-field="quantity" data-index="${n}">${e.quantity||"N/A"}</td>\n            <td class="editable text-end" data-field="unit_price" data-index="${n}">${e.unit_price?`$${e.unit_price}`:"N/A"}</td>\n            <td class="editable text-end" data-field="amount" data-index="${n}">${e.amount?`$${e.amount}`:"N/A"}</td>\n        `,t.appendChild(s)})}}function r(){document.querySelectorAll(".editable").forEach(e=>{e.addEventListener("click",function(){if(this.classList.contains("editing"))return;const t=this.textContent,n=this.dataset.field,s=this.dataset.index,a=document.createElement("input");a.type="text",a.className="form-control form-control-sm",a.value=t.replace("$","").replace("N/A",""),this.dataset.originalContent=this.innerHTML,this.classList.add("editing"),this.innerHTML="",this.appendChild(a),a.focus(),a.addEventListener("blur",function(){let t=this.value.trim();if(""===t)return e.innerHTML=e.dataset.originalContent,void e.classList.remove("editing");e.classList.contains("text-end")&&!isNaN(parseFloat(t))&&(t=`$${parseFloat(t).toFixed(2)}`),e.textContent=t,e.classList.remove("editing"),l(n,t,s)}),a.addEventListener("keydown",function(t){"Enter"===t.key?this.blur():"Escape"===t.key&&(e.innerHTML=e.dataset.originalContent,e.classList.remove("editing"))})})})}function l(e,t,s){const a=JSON.parse(sessionStorage.getItem("currentResult"));if(a){if("string"==typeof t&&t.startsWith("$")&&(t=t.substring(1)),isNaN(parseFloat(t))||"description"===e||"invoice_number"===e||(t=parseFloat(t)),void 0!==s)a.extracted_data.line_items||(a.extracted_data.line_items=[]),a.extracted_data.line_items[s]||(a.extracted_data.line_items[s]={}),a.extracted_data.line_items[s][e]=t;else{const n=e.replace(/([A-Z])/g,"_$1").toLowerCase();a.extracted_data[n]=t}a.confidence_scores||(a.confidence_scores={}),a.confidence_scores[e]=1,sessionStorage.setItem("currentResult",JSON.stringify(a)),u(a),"total_amount"!==e&&"subtotal"!==e&&"tax"!==e||n(a.confidence_scores)}}function u(e){sessionStorage.setItem("currentResult",JSON.stringify(e));let t=JSON.parse(sessionStorage.getItem("previousResults"))||[];const n=t.findIndex(t=>t.filename===e.filename&&t.extracted_data?.invoice_number===e.extracted_data?.invoice_number);n>=0?t[n]=e:(t.unshift(e),t.length>20&&(t=t.slice(0,20))),sessionStorage.setItem("previousResults",JSON.stringify(t))}function m(e){sessionStorage.setItem("currentBatch",JSON.stringify(e)),e.forEach(e=>{u(e)})}function f(){const t=JSON.parse(sessionStorage.getItem("previousResults"))||[],n=document.getElementById("previousResultsTable");if(n){if(n.innerHTML="",0===t.length){const e=document.createElement("tr");return e.innerHTML='\n            <td colspan="6" class="text-center">No previous results found</td>\n        ',void n.appendChild(e)}t.forEach((i,o)=>{const d=document.createElement("tr"),c=s(i.confidence_scores),r=i.extracted_data?.invoice_number||"N/A",l=i.extracted_data?.vendor_name||"Unknown",u=i.extracted_data?.date||"N/A",m=i.extracted_data?.total_amount?`$${i.extracted_data.total_amount}`:"N/A",f=i.timestamp?new Date(i.timestamp).toLocaleString():(new Date).toLocaleString();d.innerHTML=`\n            <td>${i.filename||`Invoice ${o+1}`}</td>\n            <td>${l}</td>\n            <td>${r}</td>\n            <td>${u}</td>\n            <td>${m}</td>\n            <td>\n                <div class="progress">\n                    <div class="progress-bar ${a(c)}" \n                         role="progressbar" \n                         style="width: ${c}%" \n                         aria-valuenow="${c}" \n                         aria-valuemin="0" \n                         aria-valuemax="100">\n                        ${c}%\n                    </div>\n                </div>\n            </td>\n            <td>${f}</td>\n            <td>\n                <button class="btn btn-sm btn-primary view-previous-btn">\n                    <i class="bi bi-eye"></i> View\n                </button>\n                <button class="btn btn-sm btn-outline-danger delete-previous-btn">\n                    <i class="bi bi-trash"></i>\n                </button>\n            </td>\n        `,n.appendChild(d);const p=d.querySelector(".view-previous-btn");p&&p.addEventListener("click",function(){const t=document.querySelector('a[href="#results-section"]');t&&t.click(),e(i)});const b=d.querySelector(".delete-previous-btn");b&&b.addEventListener("click",function(){t.splice(o,1),sessionStorage.setItem("previousResults",JSON.stringify(t)),loadPreviousResults(),showAlert("Result deleted successfully","success")})})}}