function e(){const e=document.querySelectorAll(".nav-link"),t=document.querySelectorAll(".content-section");e.forEach(n=>{n.addEventListener("click",function(n){n.preventDefault(),e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),this.classList.add("active");const a=this.getAttribute("href").substring(1),o=document.getElementById(a);if(o)if(o.classList.add("active"),"upload"===a){s();const e=document.getElementById("result");e&&e.classList.remove("active")}else"extractions"===a?d():"dashboard"===a&&m();else i("Section not found: "+a,"danger")})});const n=document.getElementById("backToUpload");n&&n.addEventListener("click",function(){"true"===this.getAttribute("data-from-batch")?(this.setAttribute("data-from-batch","false"),this.innerHTML='<i class="bi bi-arrow-left"></i> Back to Upload',g("extractions")):(g("extractions"),d())}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.classList.contains("nav-link")||e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href").substring(1),n=document.getElementById(t),a=document.querySelector(`a[href="#${t}"]`);n&&a&&a.click()})})}function t(){const e=document.getElementById("mobileSidebarToggle"),t=document.querySelector(".sidebar");e&&t&&(e.addEventListener("click",function(){t.classList.toggle("active"),document.body.classList.toggle("sidebar-open")}),document.querySelectorAll(".nav-link").forEach(e=>{e.addEventListener("click",function(){window.innerWidth<992&&(t.classList.remove("active"),document.body.classList.remove("sidebar-open"))})}))}function n(){const e=document.getElementById("uploadArea"),t=document.getElementById("dropzone"),n=document.getElementById("filePreview"),c=document.getElementById("uploadProgress"),r=document.getElementById("fileInput"),l=document.getElementById("browseButton"),u=document.getElementById("fileName"),f=document.getElementById("fileSize"),y=document.getElementById("uploadButton"),v=document.getElementById("cancelButton"),p=document.getElementById("processAnother");function h(e){e.preventDefault(),e.stopPropagation()}function b(e){if(e.length>0){if(1===e.length){const t=e[0];if("application/pdf"!==t.type)return void i("Please select PDF files only","danger");u.textContent=t.name,f.textContent=o(t.size)}else{let t=0,n=0;for(let a=0;a<e.length;a++)"application/pdf"===e[a].type&&(t++,n+=e[a].size);if(0===t)return void i("Please select PDF files only","danger");u.textContent=`${t} files selected`,f.textContent=o(n)}t.style.display="none",n.style.display="flex",y.files=e}}e&&r&&(l&&l.addEventListener("click",function(){r.click()}),r.addEventListener("change",function(){b(this.files)}),["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,h,!1)}),["dragenter","dragover"].forEach(n=>{e.addEventListener(n,function(){t.classList.add("dragging")},!1)}),["dragleave","drop"].forEach(n=>{e.addEventListener(n,function(){t.classList.remove("dragging")},!1)}),e.addEventListener("drop",function(e){b(e.dataTransfer.files)},!1),y&&y.addEventListener("click",function(){if(!this.files||0===this.files.length)return;n.style.display="none",c.style.display="block";const e=new FormData;for(let t=0;t<this.files.length;t++)"application/pdf"===this.files[t].type&&e.append("invoice",this.files[t]);const t=c.querySelector(".progress-bar");t.style.width="0%",function(e,t){const n=new XMLHttpRequest;n.open("POST","/upload"),n.upload.addEventListener("progress",function(e){if(e.lengthComputable){const n=e.loaded/e.total*100;t.style.width=n+"%"}}),n.onload=function(){if(200===n.status)try{const e=JSON.parse(n.responseText);t.style.width="100%";const s=e.success_count||0,o=e.total_files||0;if(i(`Processed ${s} of ${o} invoices successfully!`,"success"),e.results&&Array.isArray(e.results)&&e.results.length>1){const t=document.createElement("div");t.className="batch-summary section-card mb-4",t.innerHTML=`\n                            <div class="card-header d-flex justify-content-between align-items-center">\n                                <h3>Batch Processing Summary</h3>\n                            </div>\n                            <div class="card-content">\n                                <div class="alert alert-success">\n                                    <strong>Successfully processed ${s} of ${o} invoices</strong>\n                                </div>\n                                <div class="table-responsive">\n                                    <table class="table">\n                                        <thead>\n                                            <tr>\n                                                <th>Filename</th>\n                                                <th>Status</th>\n                                                <th>Invoice #</th>\n                                                <th>Company</th>\n                                                <th>Action</th>\n                                            </tr>\n                                        </thead>\n                                        <tbody>\n                                            ${e.results.map(t=>{const n=t.result||{};return`\n                                                <tr>\n                                                    <td>${t.filename||"Unknown"}</td>\n                                                    <td><span class="badge bg-success">Processed</span></td>\n                                                    <td>${n.invoice_number||"-"}</td>\n                                                    <td>${n.company_name||"-"}</td>\n                                                    <td>\n                                                        <button class="btn btn-sm btn-primary view-batch-result" \n                                                                data-index="${e.results.indexOf(t)}">\n                                                            View Details\n                                                        </button>\n                                                    </td>\n                                                </tr>\n                                                `}).join("")}\n                                        </tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        `,window.batchResults=e.results;const n=(new Date).getTime();fetch(`/extraction_history?_=${n}`,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});const c=document.getElementById("extractions");if(c){g("extractions");const e=c.querySelector(".section-header");e&&e.nextSibling?c.insertBefore(t,e.nextSibling):c.appendChild(t),document.querySelectorAll(".view-batch-result").forEach(e=>{e.addEventListener("click",function(){const e=parseInt(this.getAttribute("data-index"),10),t=window.batchResults[e];if(t){g("result");const e=document.getElementById("backToUpload");e&&(e.innerHTML='<i class="bi bi-arrow-left"></i> Back to Results',e.setAttribute("data-from-batch","true")),a(t.result||t)}})})}d()}else{document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active"));const t=document.getElementById("result");if(t)if(t.classList.add("active"),e.results&&Array.isArray(e.results)&&e.results.length>0){const t=e.results[0];t.result?(t.result.filename=t.filename,a(t.result)):a(t)}else e.result?a(e.result):a(e)}m()}catch(e){i("Error processing response","danger"),s()}else i("Error processing invoice. Please try again.","danger"),s()},n.onerror=function(){i("Network error. Please check your connection and try again.","danger"),s()},n.send(e)}(e,t)}),v&&v.addEventListener("click",function(){s()}),p&&p.addEventListener("click",function(){const e=document.querySelector('a[href="#upload"]');e&&e.click(),s()}))}function a(e){const t=document.getElementById("resultFileName");t&&(t.textContent=e.filename||"Invoice Results");const n=document.getElementById("confidenceBadge");if(n&&e.confidence_scores&&e.confidence_scores.overall){const t=Math.round(100*e.confidence_scores.overall);n.textContent=`${t}% Confidence`,n.style.backgroundColor=t>=85?"var(--success)":t>=70?"var(--warning)":"var(--danger)"}const a=document.getElementById("companyName"),s=document.getElementById("invoiceNumber"),o=document.getElementById("invoiceDate"),c=document.getElementById("fssaiNumber");a&&(a.textContent=e.company_name||"-"),s&&(s.textContent=e.invoice_number||"-"),o&&(o.textContent=e.invoice_date||"-"),c&&(c.textContent=e.fssai_number||"-");const d=document.getElementById("productTableBody");d&&(d.innerHTML="",e.products&&e.products.length>0?e.products.forEach((e,t)=>{const n=document.createElement("tr");n.innerHTML=`\n                    <td>${e.goods_description||"-"}</td>\n                    <td>${e.hsn_sac_code||"-"}</td>\n                    <td>${e.quantity||"-"}</td>\n                    <td>${e.weight||"-"}</td>\n                    <td>${e.rate||"-"}</td>\n                    <td>${e.amount||"-"}</td>\n                `,d.appendChild(n)}):d.innerHTML='\n                <tr>\n                    <td colspan="6" class="text-center">No product data available</td>\n                </tr>\n            ');const r=document.getElementById("downloadExcel");if(r){const t=r.cloneNode(!0);r.parentNode.replaceChild(t,r),t.addEventListener("click",function(){const t={company_name:e.company_name||null,invoice_number:e.invoice_number||null,invoice_date:e.invoice_date||null,fssai_number:e.fssai_number||null,products:e.products||[]};fetch("/download/excel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{if(e.ok)return e.blob();throw new Error("Failed to generate Excel file")}).then(e=>{const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=`invoice_data_${Date.now()}.xlsx`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),i("Excel file downloaded successfully","success")}).catch(e=>{i("Failed to generate Excel file","danger")})})}}function s(){const e=document.getElementById("uploadArea"),t=document.getElementById("dropzone"),n=document.getElementById("filePreview"),a=document.getElementById("uploadProgress"),s=document.getElementById("fileInput");if(!(e&&t&&n&&a&&s))return;s.value="";const o=document.getElementById("uploadButton");o&&(o.files=null),t.style.display="flex",n.style.display="none",a.style.display="none";const c=a.querySelector(".progress-bar");c&&(c.style.width="0%");const i=document.getElementById("fileName"),d=document.getElementById("fileSize");i&&(i.textContent=""),d&&(d.textContent=""),t.classList.remove("dragging");const r=document.getElementById("uploadCard");r&&(r.style.display="block")}function o(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t]}function c(){if(!document.getElementById("alertContainer")){const e=document.createElement("div");e.id="alertContainer",e.className="alert-container",document.body.appendChild(e)}}function i(e,t="info",n=null){const a=document.getElementById("alertContainer");if(!a)return null;let s,o="info-circle";"success"===t&&(o="check-circle"),"warning"===t&&(o="exclamation-triangle"),"danger"===t&&(o="exclamation-circle");let c=!0;if(n&&(s=document.getElementById(n),s&&(c=!1,s.style.transition="opacity 0.3s",s.style.opacity="0.5",s.className=`alert alert-${t}`,setTimeout(()=>{s.innerHTML=`\n                    <div class="d-flex align-items-center">\n                        <i class="bi bi-${o} me-2"></i>\n                        <div>${e}</div>\n                        <button type="button" class="btn-close ms-auto" aria-label="Close"></button>\n                    </div>\n                `,s.style.opacity="1";const t=s.querySelector(".btn-close");t&&t.addEventListener("click",function(){s.remove()})},300))),c){const n="alert-"+Date.now();s=document.createElement("div"),s.id=n,s.className=`alert alert-${t}`,s.innerHTML=`\n            <div class="d-flex align-items-center">\n                <i class="bi bi-${o} me-2"></i>\n                <div>${e}</div>\n                <button type="button" class="btn-close ms-auto" aria-label="Close"></button>\n            </div>\n        `,a.appendChild(s);const c=s.querySelector(".btn-close");c&&c.addEventListener("click",function(){s.remove()})}return setTimeout(()=>{s.classList.add("fade-out"),setTimeout(()=>{s.parentNode===a&&a.removeChild(s)},300)},5e3),s.id}function d(){const e=document.getElementById("extractionsTable"),t=document.getElementById("noExtractionsMessage"),n=document.getElementById("extractionsTableBody");e&&t&&n&&(t.textContent="Loading extractions...",t.style.display="block",e.style.display="none",fetch("/extraction_history").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(a=>{if(a&&a.extractions&&a.extractions.length>0){const s=a.extractions;e.style.display="block",t.style.display="none",n.innerHTML="",s.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                        <td>${e.filename||"Unknown File"}</td>\n                        <td>${e.company_name||"-"}</td>\n                        <td>${e.invoice_number||"-"}</td>\n                        <td>${e.invoice_date||"-"}</td>\n                        <td>\n                            <span class="confidence-badge" style="background-color: ${r(e.confidence_overall)}">\n                                ${Math.round(100*(e.confidence_overall||0))}%\n                            </span>\n                        </td>\n                        <td>\n                            <button class="btn btn-sm btn-outline-primary view-extraction" data-id="${e.id}">\n                                <i class="bi bi-eye"></i> View\n                            </button>\n                        </td>\n                    `,n.appendChild(t)}),document.querySelectorAll(".view-extraction").forEach(e=>{e.addEventListener("click",function(){l(this.getAttribute("data-id"))})})}else e.style.display="none",t.textContent="No previous extractions found. Upload an invoice to get started.",t.style.display="block"}).catch(n=>{e.style.display="none",t.textContent="Error loading extractions. Please try again.",t.style.display="block",i("Failed to load extraction history: "+n.message,"danger")}))}function r(e){const t=Math.round(100*(e||0));return t>=85?"var(--success)":t>=70?"var(--warning)":"var(--danger)"}function l(e){const t=i("Loading extraction...","info");fetch(`/extraction/${e}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active"));const n=document.getElementById("result");if(n){if(n.classList.add("active"),e.results&&Array.isArray(e.results)&&e.results.length>0){const t=e.results[0];t.result?(t.result.filename=t.filename,a(t.result)):a(t)}else e.result?(e.filename&&!e.result.filename&&(e.result.filename=e.filename),a(e.result)):a(e);i("Extraction data loaded successfully","success",t)}else i("Error: Result section not found","danger")}).catch(e=>{i("Failed to load extraction details: "+e.message,"danger",t)})}function u(){m()}function m(){fetch("/dashboard_stats").then(e=>e.json()).then(e=>{document.getElementById("totalInvoices").textContent=e.total_invoices||0,document.getElementById("successRate").textContent=`${Math.round(100*(e.success_rate||0))}%`,document.getElementById("avgProcessingTime").textContent=`${e.avg_processing_time||0}s`,document.getElementById("activeToday").textContent=e.active_today||0,f(e.recent_uploads||[])}).catch(e=>{})}function f(e){const t=document.getElementById("recentUploadsEmpty"),n=document.getElementById("recentUploadsTable"),a=document.getElementById("recentUploadsTableBody");t&&n&&a&&(e.length>0?(n.style.display="block",t.style.display="none",a.innerHTML="",e.slice(0,5).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                <td>${e.filename||"Unknown File"}</td>\n                <td>${e.vendor_name||"-"}</td>\n                <td>${e.invoice_number||"-"}</td>\n                <td>${e.invoice_date||"-"}</td>\n                <td>\n                    <button class="btn btn-sm btn-outline-primary view-extraction" data-id="${e.id}">\n                        <i class="bi bi-eye"></i> View\n                    </button>\n                </td>\n            `,a.appendChild(t)}),document.querySelectorAll(".view-extraction").forEach(e=>{e.addEventListener("click",function(){l(this.getAttribute("data-id"))})})):(n.style.display="none",t.style.display="block"))}function y(){fetch("/recent_uploads").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{f(e.uploads)}).catch(e=>{})}function v(e){if(!e||!Array.isArray(e)||0===e.length)return;const t=document.createElement("div");t.className="modal fade",t.id="batchSummaryModal",t.setAttribute("tabindex","-1"),t.setAttribute("role","dialog"),t.setAttribute("aria-labelledby","batchSummaryModalLabel"),t.setAttribute("aria-hidden","true");const n=e.filter(e=>e.success||e.result&&Object.keys(e.result).length>0).length;t.innerHTML=`\n        <div class="modal-dialog modal-lg" role="document">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <h5 class="modal-title" id="batchSummaryModalLabel">Batch Processing Summary</h5>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                </div>\n                <div class="modal-body">\n                    <div class="alert alert-info">\n                        <strong>Successfully processed ${n} of ${e.length} invoices.</strong>\n                        <p>Full results are available in the Previous Extractions section.</p>\n                    </div>\n                    <div class="table-responsive">\n                        <table class="table table-striped">\n                            <thead>\n                                <tr>\n                                    <th>Filename</th>\n                                    <th>Status</th>\n                                    <th>Company</th>\n                                    <th>Invoice #</th>\n                                    <th>Date</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${e.map(e=>{const t=e.success||e.result&&Object.keys(e.result).length>0,n=e.result||e;return`\n                                    <tr>\n                                        <td>${e.filename||"Unknown"}</td>\n                                        <td>${t?'<span class="badge bg-success">Success</span>':'<span class="badge bg-danger">Failed</span>'}</td>\n                                        <td>${n.company_name||"-"}</td>\n                                        <td>${n.invoice_number||"-"}</td>\n                                        <td>${n.invoice_date||"-"}</td>\n                                    </tr>\n                                    `}).join("")}\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n                <div class="modal-footer">\n                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n                    <button type="button" class="btn btn-primary" id="viewExtractionsBtn">View in Extractions</button>\n                </div>\n            </div>\n        </div>\n    `,document.body.appendChild(t);const a=new bootstrap.Modal(t);a.show();const s=document.getElementById("viewExtractionsBtn");s&&s.addEventListener("click",function(){a.hide(),g("extractions"),d()}),t.addEventListener("hidden.bs.modal",function(){document.body.removeChild(t)})}function g(e){document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active"));const t=document.getElementById(e);t&&t.classList.add("active")}function u(){const e=document.getElementById("refreshDashboardBtn");e&&e.addEventListener("click",function(){m(),i("Dashboard refreshed","info")}),m(),x()}function m(){fetch("/dashboard_stats").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{p("totalInvoices",e.totalInvoices),p("successRate",Math.round(e.successRate)+"%"),p("avgProcessingTime",e.avgProcessingTime.toFixed(1)+"s"),L(e)}).catch(e=>{})}function p(e,t){const n=document.getElementById(e);n&&(n.textContent=t,n.classList.add("stat-updated"),setTimeout(()=>{n.classList.remove("stat-updated")},1e3))}function h(e){const t=document.getElementById("accuracyBreakdown");if(!t)return;const n=e.fieldAccuracy||{invoice_number:95,date:90,total_amount:85,vendor_name:92,line_items:78};t.innerHTML="",Object.keys(n).forEach(e=>{const a=n[e],s=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),o=document.createElement("div");o.className="accuracy-bar-container mb-2",o.innerHTML=`\n            <div class="d-flex justify-content-between mb-1">\n                <span>${s}</span>\n                <span class="accuracy-value">${a}%</span>\n            </div>\n            <div class="progress">\n                <div class="progress-bar ${b(a)}" \n                     role="progressbar" \n                     style="width: ${a}%" \n                     aria-valuenow="${a}" \n                     aria-valuemin="0" \n                     aria-valuemax="100"></div>\n            </div>\n        `,t.appendChild(o)})}function b(e){return e>=90?"bg-success":e>=75?"bg-info":e>=60?"bg-warning":"bg-danger"}function E(e){const t=document.getElementById("recentInvoicesTable");if(!t)return;t.innerHTML="";const n=e||[];if(0===n.length){const e=document.createElement("tr");return e.innerHTML='\n            <td colspan="5" class="text-center">No invoices processed yet</td>\n        ',void t.appendChild(e)}n.forEach((e,n)=>{const a=document.createElement("tr");e.date&&new Date(e.date).toLocaleDateString(),a.innerHTML=`\n            <td>${e.filename||`Invoice ${n+1}`}</td>\n            <td>${e.vendor||"Unknown"}</td>\n            <td>${e.invoiceNumber||"N/A"}</td>\n            <td>${e.totalAmount?"$"+e.totalAmount:"N/A"}</td>\n            <td><span class="badge ${b(e.accuracy)}">${e.accuracy}%</span></td>\n        `,t.appendChild(a)})}function x(){"undefined"!=typeof Chart&&(B(),I())}function B(){const e=document.getElementById("accuracyTrendChart");if(!e)return;const t=e.getContext("2d");window.accuracyChart=new Chart(t,{type:"line",data:{labels:[],datasets:[{label:"Accuracy Trend",data:[],borderColor:"rgb(75, 192, 192)",tension:.1,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!1,min:50,max:100}}}}),L(T())}function I(){const e=document.getElementById("volumeChart");if(!e)return;const t=e.getContext("2d");window.volumeChart=new Chart(t,{type:"bar",data:{labels:[],datasets:[{label:"Invoices Processed",data:[],backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgb(54, 162, 235)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}}),L(T())}function L(e){window.accuracyChart&&e.accuracyTrend&&(window.accuracyChart.data.labels=e.accuracyTrend.dates||w(7),window.accuracyChart.data.datasets[0].data=e.accuracyTrend.values||_(7),window.accuracyChart.update()),window.volumeChart&&e.volumeTrend&&(window.volumeChart.data.labels=e.volumeTrend.dates||w(7),window.volumeChart.data.datasets[0].data=e.volumeTrend.values||C(7),window.volumeChart.update())}function w(e){const t=[],n=new Date;for(let a=e-1;a>=0;a--){const e=new Date;e.setDate(n.getDate()-a),t.push(e.toLocaleDateString("en-US",{month:"short",day:"numeric"}))}return t}function _(e){const t=[];for(let n=0;n<e;n++)t.push(85+Math.floor(10*Math.random()));return t}function C(e){const t=[];for(let n=0;n<e;n++)t.push(Math.floor(10*Math.random())+1);return t}function T(){const e=localStorage.getItem("invoiceStats");return e?JSON.parse(e):{totalInvoices:0,averageAccuracy:0,averageProcessingTime:0,lastProcessedDate:null,recentInvoices:[],fieldAccuracy:{invoice_number:0,date:0,total_amount:0,vendor_name:0,line_items:0},accuracyTrend:{dates:w(7),values:[0,0,0,0,0,0,0]},volumeTrend:{dates:w(7),values:[0,0,0,0,0,0,0]}}}function k(e,t){const n=T();if(n.totalInvoices+=e.length,n.lastProcessedDate=(new Date).toISOString(),n.totalInvoices===e.length)n.averageProcessingTime=t;else{const a=n.averageProcessingTime*(n.totalInvoices-e.length)+t*e.length;n.averageProcessingTime=a/n.totalInvoices}const a={},s={};e.forEach(e=>{e.confidence_scores&&Object.keys(e.confidence_scores).forEach(t=>{const n=e.confidence_scores[t];"number"==typeof n&&(a[t]=(a[t]||0)+1,s[t]=(s[t]||0)+n)});const t=e.confidence_scores?Object.values(e.confidence_scores).filter(e=>"number"==typeof e):[],o=t.length>0?Math.round(t.reduce((e,t)=>e+t,0)/t.length*100):Math.round(70+25*Math.random()),c={filename:e.filename||`Invoice ${n.totalInvoices}`,vendor:e.extracted_data?.vendor_name||"Unknown",invoiceNumber:e.extracted_data?.invoice_number||"N/A",totalAmount:e.extracted_data?.total_amount||"N/A",accuracy:o,date:(new Date).toISOString()};n.recentInvoices.unshift(c)}),n.recentInvoices=n.recentInvoices.slice(0,10),Object.keys(a).length>0&&(n.fieldAccuracy={},Object.keys(a).forEach(e=>{n.fieldAccuracy[e]=Math.round(s[e]/a[e]*100)}));const o=Object.values(n.fieldAccuracy);return n.averageAccuracy=o.length>0?o.reduce((e,t)=>e+t,0)/o.length:0,S(n,e),localStorage.setItem("invoiceStats",JSON.stringify(n)),n}function S(e,t){const n=(new Date).toLocaleDateString("en-US",{month:"short",day:"numeric"});e.accuracyTrend||(e.accuracyTrend={dates:w(7),values:_(7)}),e.volumeTrend||(e.volumeTrend={dates:w(7),values:C(7)});const a=e.accuracyTrend.dates.indexOf(n);if(a>=0){const n=[];t.forEach(e=>{if(e.confidence_scores){const t=Object.values(e.confidence_scores).filter(e=>"number"==typeof e);if(t.length>0){const e=t.reduce((e,t)=>e+t,0)/t.length*100;n.push(e)}}});const s=n.length>0?Math.round(n.reduce((e,t)=>e+t,0)/n.length):Math.round(e.averageAccuracy),o=e.volumeTrend.values[a],c=o+t.length,i=e.accuracyTrend.values[a];e.accuracyTrend.values[a]=Math.round((i*o+s*t.length)/c),e.volumeTrend.values[a]=c}else{const a=Math.round(e.averageAccuracy);e.accuracyTrend.dates.push(n),e.accuracyTrend.values.push(a),e.volumeTrend.dates.push(n),e.volumeTrend.values.push(t.length),e.accuracyTrend.dates.length>7&&(e.accuracyTrend.dates=e.accuracyTrend.dates.slice(-7),e.accuracyTrend.values=e.accuracyTrend.values.slice(-7),e.volumeTrend.dates=e.volumeTrend.dates.slice(-7),e.volumeTrend.values=e.volumeTrend.values.slice(-7))}}function A(e){const t=document.getElementById("resultCard");if(!t)return;t.style.display="block";const n=document.getElementById("batchResultCard");n&&(n.style.display="none");const a=document.getElementById("backToBatchBtn");a&&(a.style.display="none");const s=document.getElementById("resultTitle");s&&(s.textContent=e.filename||"Invoice Processing Results"),M(e.confidence_scores),F(e.extracted_data);const o=document.getElementById("jsonData");o&&(o.textContent=JSON.stringify(e,null,2)),U(e)}function N(e){const t=document.getElementById("batchResultCard");if(!t)return;t.style.display="block";const n=document.getElementById("resultCard");n&&(n.style.display="none");const a=document.getElementById("batchResultsTable");a&&(a.innerHTML="",e.results.forEach((t,n)=>{const s=document.createElement("tr");s.className="invoice-row",s.dataset.index=n;const o=P(t.confidence_scores),c=t.extracted_data?.invoice_number||"N/A",i=t.extracted_data?.vendor_name||"Unknown",d=t.extracted_data?.date||"N/A",r=t.extracted_data?.total_amount?`$${t.extracted_data.total_amount}`:"N/A";s.innerHTML=`\n                <td>${t.filename||`Invoice ${n+1}`}</td>\n                <td>${i}</td>\n                <td>${c}</td>\n                <td>${d}</td>\n                <td>${r}</td>\n                <td>\n                    <div class="progress">\n                        <div class="progress-bar ${D(o)}" \n                             role="progressbar" \n                             style="width: ${o}%" \n                             aria-valuenow="${o}" \n                             aria-valuemin="0" \n                             aria-valuemax="100">\n                            ${o}%\n                        </div>\n                    </div>\n                </td>\n                <td>\n                    <button class="btn btn-sm btn-primary view-invoice-btn">\n                        <i class="bi bi-eye"></i> View\n                    </button>\n                </td>\n            `,a.appendChild(s);const l=s.querySelector(".view-invoice-btn");l&&l.addEventListener("click",function(){A(e.results[n]);const t=document.getElementById("backToBatchBtn");t&&(t.style.display="block")})}));const s=document.getElementById("totalInvoices");s&&(s.textContent=e.results.length);const o=document.getElementById("avgConfidence");if(o){let t=0;e.results.forEach(e=>{t+=P(e.confidence_scores)});const n=Math.round(t/e.results.length);o.textContent=`${n}%`}const c=document.getElementById("totalAmount");if(c){let t=0;e.results.forEach(e=>{if(e.extracted_data?.total_amount){const n=parseFloat(e.extracted_data.total_amount);isNaN(n)||(t+=n)}}),c.textContent=`$${t.toFixed(2)}`}J(e.results)}function M(e){const t=document.getElementById("confidenceScore");if(!t)return;const n=P(e);t.textContent=`${n}%`,t.className=`confidence-score ${D(n)}`;const a=document.getElementById("confidenceGauge");a&&(a.style.setProperty("--percentage",`${n}%`),a.className=`confidence-gauge ${D(n)}`),H(e)}function P(e){if(!e||"object"!=typeof e)return 85;const t=Object.values(e).filter(e=>"number"==typeof e);if(0===t.length)return 85;const n=t.reduce((e,t)=>e+t,0)/t.length;return Math.round(100*n)}function D(e){return e>=90?"confidence-high":e>=75?"confidence-medium":e>=60?"confidence-low":"confidence-very-low"}function H(e){const t=document.getElementById("confidenceBreakdown");t&&e&&(t.innerHTML="",Object.entries(e).forEach(([e,n])=>{if("number"!=typeof n)return;const a=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),s=Math.round(100*n),o=document.createElement("div");o.className="confidence-breakdown-item mb-2",o.innerHTML=`\n            <div class="d-flex justify-content-between mb-1">\n                <span>${a}</span>\n                <span>${s}%</span>\n            </div>\n            <div class="progress">\n                <div class="progress-bar ${D(s)}" \n                     role="progressbar" \n                     style="width: ${s}%" \n                     aria-valuenow="${s}" \n                     aria-valuemin="0" \n                     aria-valuemax="100"></div>\n            </div>\n        `,t.appendChild(o)}))}function F(e){e&&(q("invoiceNumber",e.invoice_number),q("invoiceDate",e.date),q("dueDate",e.due_date),q("poNumber",e.po_number),q("vendorName",e.vendor_name),q("vendorAddress",e.vendor_address),q("billToName",e.bill_to_name),q("billToAddress",e.bill_to_address),q("subtotal",e.subtotal,!0),q("tax",e.tax,!0),q("totalAmount",e.total_amount,!0),O(e.line_items),R())}function q(e,t,n=!1){const a=document.getElementById(e);if(!a)return;let s=t;n&&t&&(s="number"==typeof t?`$${t.toFixed(2)}`:`$${t}`),a.textContent=s||"N/A",t?a.classList.remove("not-available"):a.classList.add("not-available")}function O(e){const t=document.getElementById("lineItemsTable");if(t){if(t.innerHTML="",!e||0===e.length){const e=document.createElement("tr");return e.innerHTML='\n            <td colspan="5" class="text-center">No line items found</td>\n        ',void t.appendChild(e)}e.forEach((e,n)=>{const a=document.createElement("tr");a.innerHTML=`\n            <td class="editable" data-field="description" data-index="${n}">${e.description||"N/A"}</td>\n            <td class="editable text-center" data-field="quantity" data-index="${n}">${e.quantity||"N/A"}</td>\n            <td class="editable text-end" data-field="unit_price" data-index="${n}">${e.unit_price?`$${e.unit_price}`:"N/A"}</td>\n            <td class="editable text-end" data-field="amount" data-index="${n}">${e.amount?`$${e.amount}`:"N/A"}</td>\n        `,t.appendChild(a)})}}function R(){document.querySelectorAll(".editable").forEach(e=>{e.addEventListener("click",function(){if(this.classList.contains("editing"))return;const t=this.textContent,n=this.dataset.field,a=this.dataset.index,s=document.createElement("input");s.type="text",s.className="form-control form-control-sm",s.value=t.replace("$","").replace("N/A",""),this.dataset.originalContent=this.innerHTML,this.classList.add("editing"),this.innerHTML="",this.appendChild(s),s.focus(),s.addEventListener("blur",function(){let t=this.value.trim();if(""===t)return e.innerHTML=e.dataset.originalContent,void e.classList.remove("editing");e.classList.contains("text-end")&&!isNaN(parseFloat(t))&&(t=`$${parseFloat(t).toFixed(2)}`),e.textContent=t,e.classList.remove("editing"),j(n,t,a)}),s.addEventListener("keydown",function(t){"Enter"===t.key?this.blur():"Escape"===t.key&&(e.innerHTML=e.dataset.originalContent,e.classList.remove("editing"))})})})}function j(e,t,n){const a=JSON.parse(sessionStorage.getItem("currentResult"));if(a){if("string"==typeof t&&t.startsWith("$")&&(t=t.substring(1)),isNaN(parseFloat(t))||"description"===e||"invoice_number"===e||(t=parseFloat(t)),void 0!==n)a.extracted_data.line_items||(a.extracted_data.line_items=[]),a.extracted_data.line_items[n]||(a.extracted_data.line_items[n]={}),a.extracted_data.line_items[n][e]=t;else{const n=e.replace(/([A-Z])/g,"_$1").toLowerCase();a.extracted_data[n]=t}a.confidence_scores||(a.confidence_scores={}),a.confidence_scores[e]=1,sessionStorage.setItem("currentResult",JSON.stringify(a)),U(a),"total_amount"!==e&&"subtotal"!==e&&"tax"!==e||M(a.confidence_scores)}}function U(e){sessionStorage.setItem("currentResult",JSON.stringify(e));let t=JSON.parse(sessionStorage.getItem("previousResults"))||[];const n=t.findIndex(t=>t.filename===e.filename&&t.extracted_data?.invoice_number===e.extracted_data?.invoice_number);n>=0?t[n]=e:(t.unshift(e),t.length>20&&(t=t.slice(0,20))),sessionStorage.setItem("previousResults",JSON.stringify(t))}function J(e){sessionStorage.setItem("currentBatch",JSON.stringify(e)),e.forEach(e=>{U(e)})}function z(){const e=JSON.parse(sessionStorage.getItem("previousResults"))||[],t=document.getElementById("previousResultsTable");if(t){if(t.innerHTML="",0===e.length){const e=document.createElement("tr");return e.innerHTML='\n            <td colspan="6" class="text-center">No previous results found</td>\n        ',void t.appendChild(e)}e.forEach((n,a)=>{const s=document.createElement("tr"),o=P(n.confidence_scores),c=n.extracted_data?.invoice_number||"N/A",r=n.extracted_data?.vendor_name||"Unknown",l=n.extracted_data?.date||"N/A",u=n.extracted_data?.total_amount?`$${n.extracted_data.total_amount}`:"N/A",m=n.timestamp?new Date(n.timestamp).toLocaleString():(new Date).toLocaleString();s.innerHTML=`\n            <td>${n.filename||`Invoice ${a+1}`}</td>\n            <td>${r}</td>\n            <td>${c}</td>\n            <td>${l}</td>\n            <td>${u}</td>\n            <td>\n                <div class="progress">\n                    <div class="progress-bar ${D(o)}" \n                         role="progressbar" \n                         style="width: ${o}%" \n                         aria-valuenow="${o}" \n                         aria-valuemin="0" \n                         aria-valuemax="100">\n                        ${o}%\n                    </div>\n                </div>\n            </td>\n            <td>${m}</td>\n            <td>\n                <button class="btn btn-sm btn-primary view-previous-btn">\n                    <i class="bi bi-eye"></i> View\n                </button>\n                <button class="btn btn-sm btn-outline-danger delete-previous-btn">\n                    <i class="bi bi-trash"></i>\n                </button>\n            </td>\n        `,t.appendChild(s);const f=s.querySelector(".view-previous-btn");f&&f.addEventListener("click",function(){const e=document.querySelector('a[href="#results-section"]');e&&e.click(),A(n)});const y=s.querySelector(".delete-previous-btn");y&&y.addEventListener("click",function(){e.splice(a,1),sessionStorage.setItem("previousResults",JSON.stringify(e)),d(),i("Result deleted successfully","success")})})}}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("upload-section"),t=document.getElementById("results-section"),n=(document.getElementById("previous-results-section"),document.getElementById("uploadCard")),a=document.getElementById("uploadArea"),s=document.getElementById("uploadPrompt"),o=document.getElementById("uploadPreview"),c=document.getElementById("uploadProgress"),i=document.getElementById("fileInput"),r=document.getElementById("browseButton"),l=document.getElementById("fileName"),u=document.getElementById("fileSize"),m=document.getElementById("uploadButton"),f=document.getElementById("cancelButton"),y=document.getElementById("resultCard"),v=document.getElementById("batchResultCard"),g=document.getElementById("processAnotherBtn"),p=document.getElementById("processBatchAnotherBtn"),h=document.getElementById("backToBatchBtn"),b=document.querySelectorAll(".nav-link"),E=document.querySelectorAll(".section"),x=(document.getElementById("previousResultsTableBody"),document.getElementById("noResultsMessage"),document.querySelectorAll(".export-btn"));let B="";function I(e){e.preventDefault(),e.stopPropagation()}function L(e){if(e.length>0){if(1===e.length){const t=e[0];if("application/pdf"!==t.type)return void T("Please select PDF files only","danger");l.textContent=t.name,u.textContent=C(t.size),document.getElementById("fileCount").textContent=""}else{let t=0,n=0;for(let a=0;a<e.length;a++)"application/pdf"===e[a].type&&(t++,n+=e[a].size);if(0===t)return void T("Please select PDF files only","danger");l.textContent=`${t} files selected`,u.textContent=C(n),document.getElementById("fileCount").textContent=`${t} of ${e.length} valid PDF files will be processed`,t<e.length&&T(e.length-t+" files were ignored because they are not PDFs","warning")}s.style.display="none",o.style.display="block",m.files=e}}function w(){s.style.display="block",o.style.display="none",c.style.display="none",i.value=""}function _(n){e.classList.remove("active"),t.classList.add("active"),document.querySelectorAll(".nav-link").forEach(e=>e.classList.remove("active")),document.getElementById("upload-tab").classList.add("active"),y.style.display="block",document.getElementById("resultCompanyName").textContent=n.company_name,document.getElementById("resultInvoiceNumber").textContent=n.invoice_number,document.getElementById("resultInvoiceDate").textContent=n.invoice_date,document.getElementById("resultFssaiNumber").textContent=n.fssai_number;const a=document.getElementById("productsTableBody");if(a.innerHTML="",n.products&&n.products.length>0)n.products.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                    <td>${e.goods_description}</td>\n                    <td>${e.hsn_sac_code}</td>\n                    <td>${e.quantity}</td>\n                    <td>${e.weight}</td>\n                    <td>${e.rate}</td>\n                    <td>${e.amount}</td>\n                `,a.appendChild(t)});else{const e=document.createElement("tr");e.innerHTML='\n                <td colspan="6" class="text-center">No product details found in invoice</td>\n            ',a.appendChild(e)}}function C(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function T(e,t){const n=document.createElement("div");n.className=`alert alert-${t} alert-dismissible fade show`,n.innerHTML=`\n            ${e}\n            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n        `,document.querySelector("main").prepend(n),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},5e3)}b.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault(),b.forEach(e=>e.classList.remove("active")),E.forEach(e=>e.classList.remove("active")),this.classList.add("active");const t=this.getAttribute("href").substring(1);document.getElementById(t).classList.add("active"),"upload-section"===t?(y.style.display="none",v.style.display="none",n.style.display="block",w()):"previous-results-section"===t&&d()})}),r.addEventListener("click",function(){i.click()}),i.addEventListener("change",function(){L(this.files)}),["dragenter","dragover","dragleave","drop"].forEach(e=>{a.addEventListener(e,I,!1)}),["dragenter","dragover"].forEach(e=>{a.addEventListener(e,function(){a.classList.add("dragging")},!1)}),["dragleave","drop"].forEach(e=>{a.addEventListener(e,function(){a.classList.remove("dragging")},!1)}),a.addEventListener("drop",function(e){L(e.dataTransfer.files)},!1),f.addEventListener("click",function(){w()}),m.addEventListener("click",function(){if(!this.files||0===this.files.length)return;o.style.display="none",c.style.display="block";const n=new FormData;let a=0;for(let e=0;e<this.files.length;e++)"application/pdf"===this.files[e].type&&(n.append("invoice",this.files[e]),a++);if(0===a)return T("No valid PDF files to upload","danger"),c.style.display="none",void w();fetch("/upload",{method:"POST",body:n}).then(e=>e.ok?e.json():e.json().then(e=>{throw new Error(e.error||"Error processing invoices")})).then(n=>{c.style.display="none",n.success_count>0?1===n.success_count&&1===n.results.length&&n.results[0].success?(B=n.results[0].filename,_(n.results[0])):function(n){e.classList.remove("active"),t.classList.add("active"),document.querySelectorAll(".nav-link").forEach(e=>e.classList.remove("active")),document.getElementById("upload-tab").classList.add("active"),document.getElementById("batchSuccessCount").textContent=`${n.success_count} invoice(s)`,document.getElementById("batchTotalCount").textContent=`${n.total_files} invoice(s)`;const a=document.getElementById("batchResultsTableBody");a.innerHTML="",n.results.forEach(e=>{const t=document.createElement("tr");e.success||t.classList.add("table-danger");const n=e.original_filename||"Unknown",s=e.success&&e.company_name||"N/A",o=e.success&&e.invoice_number||"N/A",c=e.success&&e.invoice_date||"N/A",i=e.success?'<span class="badge bg-success">Success</span>':'<span class="badge bg-danger">Failed</span>';let d="";d=e.success?`\n                    <button class="btn btn-sm btn-primary view-result-btn" data-filename="${e.filename}">\n                        <i class="bi bi-eye"></i> View\n                    </button>\n                    <div class="dropdown d-inline-block ms-1">\n                        <button class="btn btn-sm btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">\n                            <i class="bi bi-download"></i>\n                        </button>\n                        <ul class="dropdown-menu">\n                            <li><a class="dropdown-item download-btn" data-format="csv" data-filename="${e.filename}" href="#">CSV</a></li>\n                            <li><a class="dropdown-item download-btn" data-format="excel" data-filename="${e.filename}" href="#">Excel</a></li>\n                        </ul>\n                    </div>\n                `:`<span class="text-danger">${e.error||"Processing error"}</span>`,t.innerHTML=`\n                <td>${n}</td>\n                <td>${s}</td>\n                <td>${o}</td>\n                <td>${c}</td>\n                <td>${i}</td>\n                <td>${d}</td>\n            `,a.appendChild(t)}),v.style.display="block",document.querySelectorAll(".view-result-btn").forEach(e=>{e.addEventListener("click",function(){var e;e=this.getAttribute("data-filename"),fetch(`/results/${e}`).then(e=>{if(!e.ok)throw new Error("Failed to load invoice data");return e.json()}).then(t=>{v.style.display="none",h.style.display="block",B=e,_(t)}).catch(e=>{T(e.message,"danger")})})}),document.querySelectorAll(".download-btn").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("data-format"),n=this.getAttribute("data-filename");window.location.href=`/download/${n}?format=${t}`})}),d()}(n):(T("Failed to process any invoices. Please check file formats.","danger"),w())}).catch(e=>{c.style.display="none",T(e.message,"danger"),w()})}),h.addEventListener("click",function(){y.style.display="none",h.style.display="none",v.style.display="block"}),g.addEventListener("click",function(){y.style.display="none",h.style.display="none",E.forEach(e=>e.classList.remove("active")),e.classList.add("active"),n.style.display="block",b.forEach(e=>e.classList.remove("active")),document.getElementById("upload-tab").classList.add("active"),w()}),p.addEventListener("click",function(){v.style.display="none",E.forEach(e=>e.classList.remove("active")),e.classList.add("active"),n.style.display="block",b.forEach(e=>e.classList.remove("active")),document.getElementById("upload-tab").classList.add("active"),w()}),x.forEach(e=>{e.addEventListener("click",function(e){if(e.preventDefault(),!B)return void T("No data available to export","warning");const t=this.getAttribute("data-format");window.location.href=`/download/${B}?format=${t}`})})}),document.addEventListener("DOMContentLoaded",function(){e(),t(),n(),c(),u(),d()}),y();