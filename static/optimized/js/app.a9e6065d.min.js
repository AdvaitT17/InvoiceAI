function e(){const e=document.querySelectorAll(".nav-link"),t=document.querySelectorAll(".content-section");e.forEach(n=>{n.addEventListener("click",function(n){n.preventDefault(),e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),this.classList.add("active");const o=this.getAttribute("href").substring(1),a=document.getElementById(o);if(a)if(a.classList.add("active"),"upload"===o){s();const e=document.getElementById("result");e&&e.classList.remove("active")}else"extractions"===o?l():"dashboard"===o&&m();else i("Section not found: "+o,"danger")})});const n=document.getElementById("backToUpload");n&&n.addEventListener("click",function(){"true"===this.getAttribute("data-from-batch")?(this.setAttribute("data-from-batch","false"),this.innerHTML='<i class="bi bi-arrow-left"></i> Back to Upload',h("extractions")):(h("extractions"),l())}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.classList.contains("nav-link")||e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("href").substring(1),n=document.getElementById(t),o=document.querySelector(`a[href="#${t}"]`);n&&o&&o.click()})})}function t(){const e=document.getElementById("mobileSidebarToggle"),t=document.querySelector(".sidebar");e&&t&&(e.addEventListener("click",function(){t.classList.toggle("active"),document.body.classList.toggle("sidebar-open")}),document.querySelectorAll(".nav-link").forEach(e=>{e.addEventListener("click",function(){window.innerWidth<992&&(t.classList.remove("active"),document.body.classList.remove("sidebar-open"))})}))}function n(){const e=document.getElementById("uploadArea"),t=document.getElementById("dropzone"),n=document.getElementById("filePreview"),c=document.getElementById("uploadProgress"),d=document.getElementById("fileInput"),r=document.getElementById("browseButton"),u=document.getElementById("fileName"),y=document.getElementById("fileSize"),f=document.getElementById("uploadButton"),g=document.getElementById("cancelButton"),b=document.getElementById("processAnother");function v(e){e.preventDefault(),e.stopPropagation()}function p(e){if(e.length>0){if(1===e.length){const t=e[0];if("application/pdf"!==t.type)return void i("Please select PDF files only","danger");u.textContent=t.name,y.textContent=a(t.size)}else{let t=0,n=0;for(let o=0;o<e.length;o++)"application/pdf"===e[o].type&&(t++,n+=e[o].size);if(0===t)return void i("Please select PDF files only","danger");u.textContent=`${t} files selected`,y.textContent=a(n)}t.style.display="none",n.style.display="flex",f.files=e}}e&&d&&(r&&r.addEventListener("click",function(){d.click()}),d.addEventListener("change",function(){p(this.files)}),["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,v,!1)}),["dragenter","dragover"].forEach(n=>{e.addEventListener(n,function(){t.classList.add("dragging")},!1)}),["dragleave","drop"].forEach(n=>{e.addEventListener(n,function(){t.classList.remove("dragging")},!1)}),e.addEventListener("drop",function(e){p(e.dataTransfer.files)},!1),f&&f.addEventListener("click",function(){if(!this.files||0===this.files.length)return;n.style.display="none",c.style.display="block";const e=new FormData;for(let t=0;t<this.files.length;t++)"application/pdf"===this.files[t].type&&e.append("invoice",this.files[t]);const t=c.querySelector(".progress-bar");t.style.width="0%",function(e,t){const n=new XMLHttpRequest;n.open("POST","/upload"),n.upload.addEventListener("progress",function(e){if(e.lengthComputable){const n=e.loaded/e.total*100;t.style.width=n+"%"}}),n.onload=function(){if(200===n.status)try{const e=JSON.parse(n.responseText);t.style.width="100%";const s=e.success_count||0,a=e.total_files||0;if(i(`Processed ${s} of ${a} invoices successfully!`,"success"),e.results&&Array.isArray(e.results)&&e.results.length>1){const t=document.createElement("div");t.className="batch-summary section-card mb-4",t.innerHTML=`\n                            <div class="card-header d-flex justify-content-between align-items-center">\n                                <h3>Batch Processing Summary</h3>\n                            </div>\n                            <div class="card-content">\n                                <div class="alert alert-success">\n                                    <strong>Successfully processed ${s} of ${a} invoices</strong>\n                                </div>\n                                <div class="table-responsive">\n                                    <table class="table">\n                                        <thead>\n                                            <tr>\n                                                <th>Filename</th>\n                                                <th>Status</th>\n                                                <th>Invoice #</th>\n                                                <th>Company</th>\n                                                <th>Action</th>\n                                            </tr>\n                                        </thead>\n                                        <tbody>\n                                            ${e.results.map(t=>{const n=t.result||{};return`\n                                                <tr>\n                                                    <td>${t.filename||"Unknown"}</td>\n                                                    <td><span class="badge bg-success">Processed</span></td>\n                                                    <td>${n.invoice_number||"-"}</td>\n                                                    <td>${n.company_name||"-"}</td>\n                                                    <td>\n                                                        <button class="btn btn-sm btn-primary view-batch-result" \n                                                                data-index="${e.results.indexOf(t)}">\n                                                            View Details\n                                                        </button>\n                                                    </td>\n                                                </tr>\n                                                `}).join("")}\n                                        </tbody>\n                                    </table>\n                                </div>\n                            </div>\n                        `,window.batchResults=e.results;const n=(new Date).getTime();fetch(`/extraction_history?_=${n}`,{headers:{"Cache-Control":"no-cache",Pragma:"no-cache"}});const c=document.getElementById("extractions");if(c){h("extractions");const e=c.querySelector(".section-header");e&&e.nextSibling?c.insertBefore(t,e.nextSibling):c.appendChild(t),document.querySelectorAll(".view-batch-result").forEach(e=>{e.addEventListener("click",function(){const e=parseInt(this.getAttribute("data-index"),10),t=window.batchResults[e];if(t){h("result");const e=document.getElementById("backToUpload");e&&(e.innerHTML='<i class="bi bi-arrow-left"></i> Back to Results',e.setAttribute("data-from-batch","true")),o(t.result||t)}})})}l()}else{document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active"));const t=document.getElementById("result");if(t)if(t.classList.add("active"),e.results&&Array.isArray(e.results)&&e.results.length>0){const t=e.results[0];t.result?(t.result.filename=t.filename,o(t.result)):o(t)}else e.result?o(e.result):o(e)}m()}catch(e){i("Error processing response","danger"),s()}else i("Error processing invoice. Please try again.","danger"),s()},n.onerror=function(){i("Network error. Please check your connection and try again.","danger"),s()},n.send(e)}(e,t)}),g&&g.addEventListener("click",function(){s()}),b&&b.addEventListener("click",function(){const e=document.querySelector('a[href="#upload"]');e&&e.click(),s()}))}function o(e){const t=document.getElementById("resultFileName");t&&(t.textContent=e.filename||"Invoice Results");const n=document.getElementById("confidenceBadge");if(n&&e.confidence_scores&&e.confidence_scores.overall){const t=Math.round(100*e.confidence_scores.overall);n.textContent=`${t}% Confidence`,n.style.backgroundColor=t>=85?"var(--success)":t>=70?"var(--warning)":"var(--danger)"}const o=document.getElementById("companyName"),s=document.getElementById("invoiceNumber"),a=document.getElementById("invoiceDate"),c=document.getElementById("fssaiNumber");o&&(o.textContent=e.company_name||"-"),s&&(s.textContent=e.invoice_number||"-"),a&&(a.textContent=e.invoice_date||"-"),c&&(c.textContent=e.fssai_number||"-");const l=document.getElementById("productTableBody");l&&(l.innerHTML="",e.products&&e.products.length>0?e.products.forEach((e,t)=>{const n=document.createElement("tr");n.innerHTML=`\n                    <td>${e.goods_description||"-"}</td>\n                    <td>${e.hsn_sac_code||"-"}</td>\n                    <td>${e.quantity||"-"}</td>\n                    <td>${e.weight||"-"}</td>\n                    <td>${e.rate||"-"}</td>\n                    <td>${e.amount||"-"}</td>\n                `,l.appendChild(n)}):l.innerHTML='\n                <tr>\n                    <td colspan="6" class="text-center">No product data available</td>\n                </tr>\n            ');const d=document.getElementById("downloadExcel");if(d){const t=d.cloneNode(!0);d.parentNode.replaceChild(t,d),t.addEventListener("click",function(){const t={company_name:e.company_name||null,invoice_number:e.invoice_number||null,invoice_date:e.invoice_date||null,fssai_number:e.fssai_number||null,products:e.products||[]};fetch("/download/excel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(e=>{if(e.ok)return e.blob();throw new Error("Failed to generate Excel file")}).then(e=>{const t=URL.createObjectURL(e),n=document.createElement("a");n.href=t,n.download=`invoice_data_${Date.now()}.xlsx`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(t),i("Excel file downloaded successfully","success")}).catch(e=>{i("Failed to generate Excel file","danger")})})}}function s(){const e=document.getElementById("uploadArea"),t=document.getElementById("dropzone"),n=document.getElementById("filePreview"),o=document.getElementById("uploadProgress"),s=document.getElementById("fileInput");if(!(e&&t&&n&&o&&s))return;s.value="";const a=document.getElementById("uploadButton");a&&(a.files=null),t.style.display="flex",n.style.display="none",o.style.display="none";const c=o.querySelector(".progress-bar");c&&(c.style.width="0%");const i=document.getElementById("fileName"),l=document.getElementById("fileSize");i&&(i.textContent=""),l&&(l.textContent=""),t.classList.remove("dragging");const d=document.getElementById("uploadCard");d&&(d.style.display="block")}function a(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB","TB"][t]}function c(){if(!document.getElementById("alertContainer")){const e=document.createElement("div");e.id="alertContainer",e.className="alert-container",document.body.appendChild(e)}}function i(e,t="info",n=null){const o=document.getElementById("alertContainer");if(!o)return null;let s,a="info-circle";"success"===t&&(a="check-circle"),"warning"===t&&(a="exclamation-triangle"),"danger"===t&&(a="exclamation-circle");let c=!0;if(n&&(s=document.getElementById(n),s&&(c=!1,s.style.transition="opacity 0.3s",s.style.opacity="0.5",s.className=`alert alert-${t}`,setTimeout(()=>{s.innerHTML=`\n                    <div class="d-flex align-items-center">\n                        <i class="bi bi-${a} me-2"></i>\n                        <div>${e}</div>\n                        <button type="button" class="btn-close ms-auto" aria-label="Close"></button>\n                    </div>\n                `,s.style.opacity="1";const t=s.querySelector(".btn-close");t&&t.addEventListener("click",function(){s.remove()})},300))),c){const n="alert-"+Date.now();s=document.createElement("div"),s.id=n,s.className=`alert alert-${t}`,s.innerHTML=`\n            <div class="d-flex align-items-center">\n                <i class="bi bi-${a} me-2"></i>\n                <div>${e}</div>\n                <button type="button" class="btn-close ms-auto" aria-label="Close"></button>\n            </div>\n        `,o.appendChild(s);const c=s.querySelector(".btn-close");c&&c.addEventListener("click",function(){s.remove()})}return setTimeout(()=>{s.classList.add("fade-out"),setTimeout(()=>{s.parentNode===o&&o.removeChild(s)},300)},5e3),s.id}function l(){const e=document.getElementById("extractionsTable"),t=document.getElementById("noExtractionsMessage"),n=document.getElementById("extractionsTableBody");e&&t&&n&&(t.textContent="Loading extractions...",t.style.display="block",e.style.display="none",fetch("/extraction_history").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(o=>{if(o&&o.extractions&&o.extractions.length>0){const s=o.extractions;e.style.display="block",t.style.display="none",n.innerHTML="",s.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                        <td>${e.filename||"Unknown File"}</td>\n                        <td>${e.company_name||"-"}</td>\n                        <td>${e.invoice_number||"-"}</td>\n                        <td>${e.invoice_date||"-"}</td>\n                        <td>\n                            <span class="confidence-badge" style="background-color: ${d(e.confidence_overall)}">\n                                ${Math.round(100*(e.confidence_overall||0))}%\n                            </span>\n                        </td>\n                        <td>\n                            <button class="btn btn-sm btn-outline-primary view-extraction" data-id="${e.id}">\n                                <i class="bi bi-eye"></i> View\n                            </button>\n                        </td>\n                    `,n.appendChild(t)}),document.querySelectorAll(".view-extraction").forEach(e=>{e.addEventListener("click",function(){r(this.getAttribute("data-id"))})})}else e.style.display="none",t.textContent="No previous extractions found. Upload an invoice to get started.",t.style.display="block"}).catch(n=>{e.style.display="none",t.textContent="Error loading extractions. Please try again.",t.style.display="block",i("Failed to load extraction history: "+n.message,"danger")}))}function d(e){const t=Math.round(100*(e||0));return t>=85?"var(--success)":t>=70?"var(--warning)":"var(--danger)"}function r(e){const t=i("Loading extraction...","info");fetch(`/extraction/${e}`).then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active"));const n=document.getElementById("result");if(n){if(n.classList.add("active"),e.results&&Array.isArray(e.results)&&e.results.length>0){const t=e.results[0];t.result?(t.result.filename=t.filename,o(t.result)):o(t)}else e.result?(e.filename&&!e.result.filename&&(e.result.filename=e.filename),o(e.result)):o(e);i("Extraction data loaded successfully","success",t)}else i("Error: Result section not found","danger")}).catch(e=>{i("Failed to load extraction details: "+e.message,"danger",t)})}function u(){m()}function m(){fetch("/dashboard_stats").then(e=>e.json()).then(e=>{document.getElementById("totalInvoices").textContent=e.total_invoices||0,document.getElementById("successRate").textContent=`${Math.round(100*(e.success_rate||0))}%`,document.getElementById("avgProcessingTime").textContent=`${e.avg_processing_time||0}s`,document.getElementById("activeToday").textContent=e.active_today||0,y(e.recent_uploads||[])}).catch(e=>{})}function y(e){const t=document.getElementById("recentUploadsEmpty"),n=document.getElementById("recentUploadsTable"),o=document.getElementById("recentUploadsTableBody");t&&n&&o&&(e.length>0?(n.style.display="block",t.style.display="none",o.innerHTML="",e.slice(0,5).forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                <td>${e.filename||"Unknown File"}</td>\n                <td>${e.vendor_name||"-"}</td>\n                <td>${e.invoice_number||"-"}</td>\n                <td>${e.invoice_date||"-"}</td>\n                <td>\n                    <button class="btn btn-sm btn-outline-primary view-extraction" data-id="${e.id}">\n                        <i class="bi bi-eye"></i> View\n                    </button>\n                </td>\n            `,o.appendChild(t)}),document.querySelectorAll(".view-extraction").forEach(e=>{e.addEventListener("click",function(){r(this.getAttribute("data-id"))})})):(n.style.display="none",t.style.display="block"))}function f(){fetch("/recent_uploads").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{y(e.uploads)}).catch(e=>{})}function g(e){if(!e||!Array.isArray(e)||0===e.length)return;const t=document.createElement("div");t.className="modal fade",t.id="batchSummaryModal",t.setAttribute("tabindex","-1"),t.setAttribute("role","dialog"),t.setAttribute("aria-labelledby","batchSummaryModalLabel"),t.setAttribute("aria-hidden","true");const n=e.filter(e=>e.success||e.result&&Object.keys(e.result).length>0).length;t.innerHTML=`\n        <div class="modal-dialog modal-lg" role="document">\n            <div class="modal-content">\n                <div class="modal-header">\n                    <h5 class="modal-title" id="batchSummaryModalLabel">Batch Processing Summary</h5>\n                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>\n                </div>\n                <div class="modal-body">\n                    <div class="alert alert-info">\n                        <strong>Successfully processed ${n} of ${e.length} invoices.</strong>\n                        <p>Full results are available in the Previous Extractions section.</p>\n                    </div>\n                    <div class="table-responsive">\n                        <table class="table table-striped">\n                            <thead>\n                                <tr>\n                                    <th>Filename</th>\n                                    <th>Status</th>\n                                    <th>Company</th>\n                                    <th>Invoice #</th>\n                                    <th>Date</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                ${e.map(e=>{const t=e.success||e.result&&Object.keys(e.result).length>0,n=e.result||e;return`\n                                    <tr>\n                                        <td>${e.filename||"Unknown"}</td>\n                                        <td>${t?'<span class="badge bg-success">Success</span>':'<span class="badge bg-danger">Failed</span>'}</td>\n                                        <td>${n.company_name||"-"}</td>\n                                        <td>${n.invoice_number||"-"}</td>\n                                        <td>${n.invoice_date||"-"}</td>\n                                    </tr>\n                                    `}).join("")}\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n                <div class="modal-footer">\n                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n                    <button type="button" class="btn btn-primary" id="viewExtractionsBtn">View in Extractions</button>\n                </div>\n            </div>\n        </div>\n    `,document.body.appendChild(t);const o=new bootstrap.Modal(t);o.show();const s=document.getElementById("viewExtractionsBtn");s&&s.addEventListener("click",function(){o.hide(),h("extractions"),l()}),t.addEventListener("hidden.bs.modal",function(){document.body.removeChild(t)})}function h(e){document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active"));const t=document.getElementById(e);t&&t.classList.add("active")}document.addEventListener("DOMContentLoaded",function(){e(),t(),n(),c(),u(),l()}),f();