document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("upload-section"),t=document.getElementById("results-section"),n=(document.getElementById("previous-results-section"),document.getElementById("uploadCard")),s=document.getElementById("uploadArea"),o=document.getElementById("uploadPrompt"),a=document.getElementById("uploadPreview"),l=document.getElementById("uploadProgress"),d=document.getElementById("fileInput"),c=document.getElementById("browseButton"),i=document.getElementById("fileName"),r=document.getElementById("fileSize"),u=document.getElementById("uploadButton"),m=document.getElementById("cancelButton"),y=document.getElementById("resultCard"),f=document.getElementById("batchResultCard"),p=document.getElementById("processAnotherBtn"),g=document.getElementById("processBatchAnotherBtn"),v=document.getElementById("backToBatchBtn"),h=document.querySelectorAll(".nav-link"),E=document.querySelectorAll(".section"),b=(document.getElementById("previousResultsTableBody"),document.getElementById("noResultsMessage"),document.querySelectorAll(".export-btn"));let B="";function L(e){e.preventDefault(),e.stopPropagation()}function I(e){if(e.length>0){if(1===e.length){const t=e[0];if("application/pdf"!==t.type)return void x("Please select PDF files only","danger");i.textContent=t.name,r.textContent=C(t.size),document.getElementById("fileCount").textContent=""}else{let t=0,n=0;for(let s=0;s<e.length;s++)"application/pdf"===e[s].type&&(t++,n+=e[s].size);if(0===t)return void x("Please select PDF files only","danger");i.textContent=`${t} files selected`,r.textContent=C(n),document.getElementById("fileCount").textContent=`${t} of ${e.length} valid PDF files will be processed`,t<e.length&&x(e.length-t+" files were ignored because they are not PDFs","warning")}o.style.display="none",a.style.display="block",u.files=e}}function w(){o.style.display="block",a.style.display="none",l.style.display="none",d.value=""}function k(n){e.classList.remove("active"),t.classList.add("active"),document.querySelectorAll(".nav-link").forEach(e=>e.classList.remove("active")),document.getElementById("upload-tab").classList.add("active"),y.style.display="block",document.getElementById("resultCompanyName").textContent=n.company_name,document.getElementById("resultInvoiceNumber").textContent=n.invoice_number,document.getElementById("resultInvoiceDate").textContent=n.invoice_date,document.getElementById("resultFssaiNumber").textContent=n.fssai_number;const s=document.getElementById("productsTableBody");if(s.innerHTML="",n.products&&n.products.length>0)n.products.forEach(e=>{const t=document.createElement("tr");t.innerHTML=`\n                    <td>${e.goods_description}</td>\n                    <td>${e.hsn_sac_code}</td>\n                    <td>${e.quantity}</td>\n                    <td>${e.weight}</td>\n                    <td>${e.rate}</td>\n                    <td>${e.amount}</td>\n                `,s.appendChild(t)});else{const e=document.createElement("tr");e.innerHTML='\n                <td colspan="6" class="text-center">No product details found in invoice</td>\n            ',s.appendChild(e)}}function C(e){if(0===e)return"0 Bytes";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function x(e,t){const n=document.createElement("div");n.className=`alert alert-${t} alert-dismissible fade show`,n.innerHTML=`\n            ${e}\n            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n        `,document.querySelector("main").prepend(n),setTimeout(()=>{n.classList.remove("show"),setTimeout(()=>n.remove(),300)},5e3)}h.forEach(e=>{e.addEventListener("click",function(e){e.preventDefault(),h.forEach(e=>e.classList.remove("active")),E.forEach(e=>e.classList.remove("active")),this.classList.add("active");const t=this.getAttribute("href").substring(1);document.getElementById(t).classList.add("active"),"upload-section"===t?(y.style.display="none",f.style.display="none",n.style.display="block",w()):"previous-results-section"===t&&loadPreviousResults()})}),c.addEventListener("click",function(){d.click()}),d.addEventListener("change",function(){I(this.files)}),["dragenter","dragover","dragleave","drop"].forEach(e=>{s.addEventListener(e,L,!1)}),["dragenter","dragover"].forEach(e=>{s.addEventListener(e,function(){s.classList.add("dragging")},!1)}),["dragleave","drop"].forEach(e=>{s.addEventListener(e,function(){s.classList.remove("dragging")},!1)}),s.addEventListener("drop",function(e){I(e.dataTransfer.files)},!1),m.addEventListener("click",function(){w()}),u.addEventListener("click",function(){if(!this.files||0===this.files.length)return;a.style.display="none",l.style.display="block";const n=new FormData;let s=0;for(let e=0;e<this.files.length;e++)"application/pdf"===this.files[e].type&&(n.append("invoice",this.files[e]),s++);if(0===s)return x("No valid PDF files to upload","danger"),l.style.display="none",void w();fetch("/upload",{method:"POST",body:n}).then(e=>e.ok?e.json():e.json().then(e=>{throw new Error(e.error||"Error processing invoices")})).then(n=>{l.style.display="none",n.success_count>0?1===n.success_count&&1===n.results.length&&n.results[0].success?(B=n.results[0].filename,k(n.results[0])):function(n){e.classList.remove("active"),t.classList.add("active"),document.querySelectorAll(".nav-link").forEach(e=>e.classList.remove("active")),document.getElementById("upload-tab").classList.add("active"),document.getElementById("batchSuccessCount").textContent=`${n.success_count} invoice(s)`,document.getElementById("batchTotalCount").textContent=`${n.total_files} invoice(s)`;const s=document.getElementById("batchResultsTableBody");s.innerHTML="",n.results.forEach(e=>{const t=document.createElement("tr");e.success||t.classList.add("table-danger");const n=e.original_filename||"Unknown",o=e.success&&e.company_name||"N/A",a=e.success&&e.invoice_number||"N/A",l=e.success&&e.invoice_date||"N/A",d=e.success?'<span class="badge bg-success">Success</span>':'<span class="badge bg-danger">Failed</span>';let c="";c=e.success?`\n                    <button class="btn btn-sm btn-primary view-result-btn" data-filename="${e.filename}">\n                        <i class="bi bi-eye"></i> View\n                    </button>\n                    <div class="dropdown d-inline-block ms-1">\n                        <button class="btn btn-sm btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">\n                            <i class="bi bi-download"></i>\n                        </button>\n                        <ul class="dropdown-menu">\n                            <li><a class="dropdown-item download-btn" data-format="csv" data-filename="${e.filename}" href="#">CSV</a></li>\n                            <li><a class="dropdown-item download-btn" data-format="excel" data-filename="${e.filename}" href="#">Excel</a></li>\n                        </ul>\n                    </div>\n                `:`<span class="text-danger">${e.error||"Processing error"}</span>`,t.innerHTML=`\n                <td>${n}</td>\n                <td>${o}</td>\n                <td>${a}</td>\n                <td>${l}</td>\n                <td>${d}</td>\n                <td>${c}</td>\n            `,s.appendChild(t)}),f.style.display="block",document.querySelectorAll(".view-result-btn").forEach(e=>{e.addEventListener("click",function(){var e;e=this.getAttribute("data-filename"),fetch(`/results/${e}`).then(e=>{if(!e.ok)throw new Error("Failed to load invoice data");return e.json()}).then(t=>{f.style.display="none",v.style.display="block",B=e,k(t)}).catch(e=>{x(e.message,"danger")})})}),document.querySelectorAll(".download-btn").forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();const t=this.getAttribute("data-format"),n=this.getAttribute("data-filename");window.location.href=`/download/${n}?format=${t}`})}),loadPreviousResults()}(n):(x("Failed to process any invoices. Please check file formats.","danger"),w())}).catch(e=>{l.style.display="none",x(e.message,"danger"),w()})}),v.addEventListener("click",function(){y.style.display="none",v.style.display="none",f.style.display="block"}),p.addEventListener("click",function(){y.style.display="none",v.style.display="none",E.forEach(e=>e.classList.remove("active")),e.classList.add("active"),n.style.display="block",h.forEach(e=>e.classList.remove("active")),document.getElementById("upload-tab").classList.add("active"),w()}),g.addEventListener("click",function(){f.style.display="none",E.forEach(e=>e.classList.remove("active")),e.classList.add("active"),n.style.display="block",h.forEach(e=>e.classList.remove("active")),document.getElementById("upload-tab").classList.add("active"),w()}),b.forEach(e=>{e.addEventListener("click",function(e){if(e.preventDefault(),!B)return void x("No data available to export","warning");const t=this.getAttribute("data-format");window.location.href=`/download/${B}?format=${t}`})})});