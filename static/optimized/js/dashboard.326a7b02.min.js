function e(){const e=document.getElementById("refreshDashboardBtn");e&&e.addEventListener("click",function(){t(),showAlert("Dashboard refreshed","info")}),t(),o()}function t(){fetch("/dashboard_stats").then(e=>{if(!e.ok)throw new Error(`HTTP error! Status: ${e.status}`);return e.json()}).then(e=>{n("totalInvoices",e.totalInvoices),n("successRate",Math.round(e.successRate)+"%"),n("avgProcessingTime",e.avgProcessingTime.toFixed(1)+"s"),u(e)}).catch(e=>{})}function n(e,t){const n=document.getElementById(e);n&&(n.textContent=t,n.classList.add("stat-updated"),setTimeout(()=>{n.classList.remove("stat-updated")},1e3))}function a(e){const t=document.getElementById("accuracyBreakdown");if(!t)return;const n=e.fieldAccuracy||{invoice_number:95,date:90,total_amount:85,vendor_name:92,line_items:78};t.innerHTML="",Object.keys(n).forEach(e=>{const a=n[e],r=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),o=document.createElement("div");o.className="accuracy-bar-container mb-2",o.innerHTML=`\n            <div class="d-flex justify-content-between mb-1">\n                <span>${r}</span>\n                <span class="accuracy-value">${a}%</span>\n            </div>\n            <div class="progress">\n                <div class="progress-bar ${c(a)}" \n                     role="progressbar" \n                     style="width: ${a}%" \n                     aria-valuenow="${a}" \n                     aria-valuemin="0" \n                     aria-valuemax="100"></div>\n            </div>\n        `,t.appendChild(o)})}function c(e){return e>=90?"bg-success":e>=75?"bg-info":e>=60?"bg-warning":"bg-danger"}function r(e){const t=document.getElementById("recentInvoicesTable");if(!t)return;t.innerHTML="";const n=e||[];if(0===n.length){const e=document.createElement("tr");return e.innerHTML='\n            <td colspan="5" class="text-center">No invoices processed yet</td>\n        ',void t.appendChild(e)}n.forEach((e,n)=>{const a=document.createElement("tr");e.date&&new Date(e.date).toLocaleDateString(),a.innerHTML=`\n            <td>${e.filename||`Invoice ${n+1}`}</td>\n            <td>${e.vendor||"Unknown"}</td>\n            <td>${e.invoiceNumber||"N/A"}</td>\n            <td>${e.totalAmount?"$"+e.totalAmount:"N/A"}</td>\n            <td><span class="badge ${c(e.accuracy)}">${e.accuracy}%</span></td>\n        `,t.appendChild(a)})}function o(){"undefined"!=typeof Chart&&(s(),d())}function s(){const e=document.getElementById("accuracyTrendChart");if(!e)return;const t=e.getContext("2d");window.accuracyChart=new Chart(t,{type:"line",data:{labels:[],datasets:[{label:"Accuracy Trend",data:[],borderColor:"rgb(75, 192, 192)",tension:.1,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!1,min:50,max:100}}}}),u(m())}function d(){const e=document.getElementById("volumeChart");if(!e)return;const t=e.getContext("2d");window.volumeChart=new Chart(t,{type:"bar",data:{labels:[],datasets:[{label:"Invoices Processed",data:[],backgroundColor:"rgba(54, 162, 235, 0.5)",borderColor:"rgb(54, 162, 235)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0}}}}),u(m())}function u(e){window.accuracyChart&&e.accuracyTrend&&(window.accuracyChart.data.labels=e.accuracyTrend.dates||i(7),window.accuracyChart.data.datasets[0].data=e.accuracyTrend.values||l(7),window.accuracyChart.update()),window.volumeChart&&e.volumeTrend&&(window.volumeChart.data.labels=e.volumeTrend.dates||i(7),window.volumeChart.data.datasets[0].data=e.volumeTrend.values||v(7),window.volumeChart.update())}function i(e){const t=[],n=new Date;for(let a=e-1;a>=0;a--){const e=new Date;e.setDate(n.getDate()-a),t.push(e.toLocaleDateString("en-US",{month:"short",day:"numeric"}))}return t}function l(e){const t=[];for(let n=0;n<e;n++)t.push(85+Math.floor(10*Math.random()));return t}function v(e){const t=[];for(let n=0;n<e;n++)t.push(Math.floor(10*Math.random())+1);return t}function m(){const e=localStorage.getItem("invoiceStats");return e?JSON.parse(e):{totalInvoices:0,averageAccuracy:0,averageProcessingTime:0,lastProcessedDate:null,recentInvoices:[],fieldAccuracy:{invoice_number:0,date:0,total_amount:0,vendor_name:0,line_items:0},accuracyTrend:{dates:i(7),values:[0,0,0,0,0,0,0]},volumeTrend:{dates:i(7),values:[0,0,0,0,0,0,0]}}}function h(e,t){const n=m();if(n.totalInvoices+=e.length,n.lastProcessedDate=(new Date).toISOString(),n.totalInvoices===e.length)n.averageProcessingTime=t;else{const a=n.averageProcessingTime*(n.totalInvoices-e.length)+t*e.length;n.averageProcessingTime=a/n.totalInvoices}const a={},c={};e.forEach(e=>{e.confidence_scores&&Object.keys(e.confidence_scores).forEach(t=>{const n=e.confidence_scores[t];"number"==typeof n&&(a[t]=(a[t]||0)+1,c[t]=(c[t]||0)+n)});const t=e.confidence_scores?Object.values(e.confidence_scores).filter(e=>"number"==typeof e):[],r=t.length>0?Math.round(t.reduce((e,t)=>e+t,0)/t.length*100):Math.round(70+25*Math.random()),o={filename:e.filename||`Invoice ${n.totalInvoices}`,vendor:e.extracted_data?.vendor_name||"Unknown",invoiceNumber:e.extracted_data?.invoice_number||"N/A",totalAmount:e.extracted_data?.total_amount||"N/A",accuracy:r,date:(new Date).toISOString()};n.recentInvoices.unshift(o)}),n.recentInvoices=n.recentInvoices.slice(0,10),Object.keys(a).length>0&&(n.fieldAccuracy={},Object.keys(a).forEach(e=>{n.fieldAccuracy[e]=Math.round(c[e]/a[e]*100)}));const r=Object.values(n.fieldAccuracy);return n.averageAccuracy=r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0,f(n,e),localStorage.setItem("invoiceStats",JSON.stringify(n)),n}function f(e,t){const n=(new Date).toLocaleDateString("en-US",{month:"short",day:"numeric"});e.accuracyTrend||(e.accuracyTrend={dates:i(7),values:l(7)}),e.volumeTrend||(e.volumeTrend={dates:i(7),values:v(7)});const a=e.accuracyTrend.dates.indexOf(n);if(a>=0){const n=[];t.forEach(e=>{if(e.confidence_scores){const t=Object.values(e.confidence_scores).filter(e=>"number"==typeof e);if(t.length>0){const e=t.reduce((e,t)=>e+t,0)/t.length*100;n.push(e)}}});const c=n.length>0?Math.round(n.reduce((e,t)=>e+t,0)/n.length):Math.round(e.averageAccuracy),r=e.volumeTrend.values[a],o=r+t.length,s=e.accuracyTrend.values[a];e.accuracyTrend.values[a]=Math.round((s*r+c*t.length)/o),e.volumeTrend.values[a]=o}else{const a=Math.round(e.averageAccuracy);e.accuracyTrend.dates.push(n),e.accuracyTrend.values.push(a),e.volumeTrend.dates.push(n),e.volumeTrend.values.push(t.length),e.accuracyTrend.dates.length>7&&(e.accuracyTrend.dates=e.accuracyTrend.dates.slice(-7),e.accuracyTrend.values=e.accuracyTrend.values.slice(-7),e.volumeTrend.dates=e.volumeTrend.dates.slice(-7),e.volumeTrend.values=e.volumeTrend.values.slice(-7))}}